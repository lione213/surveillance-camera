<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بث فيديو PeerJS آمن وموثوق</title>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
       .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 900px;
            width: 100%;
        }
        h1 {
            color: #0056b3;
            margin-bottom: 25px;
            font-size: 2.2em;
        }
       .video-container {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        video {
            width: 100%;
            max-width: 400px;
            height: auto;
            background-color: #000;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transform: scaleX(-1); /* Mirror local video */
        }
       .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
        }
        button {
            padding: 12px 25px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            color: #fff;
            background-color: #007bff;
        }
        button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        input[type="text"] {
            padding: 10px 15px;
            font-size: 1em;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 200px;
            max-width: 100%;
            box-sizing: border-box;
        }
       .status-messages {
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
       .status-messages p {
            margin: 5px 0;
            font-size: 0.9em;
            color: #555;
        }
       .status-messages.error {
            color: #dc3545;
            font-weight: bold;
        }
       .status-messages.info {
            color: #007bff;
        }
       .status-messages.success {
            color: #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>بث فيديو PeerJS آمن وموثوق</h1>
        <div class="video-container">
            <div>
                <h2>الفيديو المحلي</h2>
                <video id="localVideo" autoplay muted></video>
            </div>
            <div>
                <h2>الفيديو البعيد</h2>
                <video id="remoteVideo" autoplay></video>
            </div>
        </div>
        <div class="controls">
            <button id="startStreamBtn">بدء البث المحلي</button>
            <input type="text" id="peerIdInput" placeholder="معرف النظير للاتصال به">
            <button id="callBtn" disabled>الاتصال بالنظير</button>
            <button id="answerBtn" disabled>الرد على المكالمة</button>
            <button id="hangupBtn" disabled>إنهاء المكالمة</button>
        </div>
        <div class="status-messages" id="statusMessages">
            <p class="info">انتظر تهيئة PeerJS...</p>
        </div>
    </div>

    <script>
        // عناصر DOM
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const startStreamBtn = document.getElementById('startStreamBtn');
        const peerIdInput = document.getElementById('peerIdInput');
        const callBtn = document.getElementById('callBtn');
        const answerBtn = document.getElementById('answerBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        const statusMessages = document.getElementById('statusMessages');

        // متغيرات الحالة
        let peer = null;
        let localStream = null;
        let currentCall = null;
        let incomingCall = null; // لتخزين المكالمة الواردة قبل الرد عليها

        // دالة لإضافة رسائل الحالة إلى الواجهة
        function addStatusMessage(message, type = 'info') {
            const p = document.createElement('p');
            p.textContent = message;
            p.className = type;
            statusMessages.prepend(p); // إضافة الرسائل الأحدث في الأعلى
            if (statusMessages.children.length > 20) { // الاحتفاظ بـ 20 رسالة كحد أقصى
                statusMessages.removeChild(statusMessages.lastChild);
            }
        }

        // 1. تهيئة PeerJS مع تكوين قوي
        // ملاحظات هامة:
        // - يجب أن يتم تقديم تطبيقك عبر HTTPS في بيئة الإنتاج.
        // - خادم PeerJS العام غير موثوق به. يوصى بشدة باستضافة PeerServer الخاص بك.
        // - تم إيقاف خادم TURN المجاني من PeerJS. يجب عليك توفير خادم TURN الخاص بك.
        //   بدون خادم TURN، ستفشل الاتصالات بين النظراء خلف جدران الحماية الصارمة أو Symmetric NAT.
        function initializePeer() {
            addStatusMessage("تهيئة PeerJS...");
            try {
                peer = new Peer({
                    // إذا كنت تستضيف PeerServer الخاص بك:
                    // host: 'your-custom-peerserver.com', // استبدل بعنوان خادمك
                    // port: 443, // أو المنفذ المخصص لخادمك (عادة 443 لـ WSS)
                    // path: '/myapp', // المسار الذي تم تكوين PeerServer عليه
                    // secure: true, // يجب أن يكون 'true' إذا كان تطبيقك يعمل عبر HTTPS

                    // تكوين ICE/TURN:
                    config: {
                        'iceServers':
                    },
                    debug: 3 // مستوى تسجيل الأخطاء: 0 (لا شيء)، 1 (خطأ)، 2 (تحذير)، 3 (معلومات)
                });

                // 2. معالجة أحداث PeerJS
                peer.on('open', function(id) {
                    addStatusMessage(`تم الاتصال بخادم PeerJS. معرف النظير الخاص بك: ${id}`, 'success');
                    callBtn.disabled = false;
                });

                peer.on('call', function(call) {
                    addStatusMessage(`مكالمة واردة من: ${call.peer}.`, 'info');
                    incomingCall = call;
                    answerBtn.disabled = false;
                });

                peer.on('connection', function(conn) {
                    addStatusMessage(`اتصال بيانات وارد من: ${conn.peer}.`, 'info');
                    // يمكنك إضافة معالجة لقنوات البيانات هنا إذا لزم الأمر
                    conn.on('data', function(data) {
                        addStatusMessage(`بيانات مستلمة من ${conn.peer}: ${data}`);
                    });
                });

                peer.on('error', function(err) {
                    addStatusMessage(`خطأ PeerJS: ${err.type} - ${err.message}`, 'error');
                    // أنواع الأخطاء الشائعة: 'network', 'peer-unavailable', 'ssl-unavailable', 'server-error'
                    // معالجة الأخطاء القاتلة:
                    if (['browser-incompatible', 'invalid-id', 'invalid-key', 'ssl-unavailable', 'server-error', 'socket-error', 'socket-closed'].includes(err.type)) {
                        addStatusMessage("خطأ PeerJS قاتل. يرجى تحديث الصفحة أو التحقق من التكوين.", 'error');
                        peer = null; // تدمير كائن النظير المعطوب
                    }
                });

                peer.on('disconnected', function() {
                    addStatusMessage("تم قطع الاتصال بخادم PeerJS. محاولة إعادة الاتصال...", 'info');
                    // يمكن محاولة إعادة الاتصال تلقائيًا
                    if (peer &&!peer.destroyed) {
                        peer.reconnect();
                    }
                });

                peer.on('close', function() {
                    addStatusMessage("تم إغلاق اتصال PeerJS. لا يمكن إنشاء/قبول اتصالات جديدة.", 'info');
                    // إعادة تعيين الحالة إذا تم إغلاق النظير
                    peer = null;
                    callBtn.disabled = true;
                    answerBtn.disabled = true;
                    hangupBtn.disabled = true;
                });

            } catch (e) {
                addStatusMessage(`فشل تهيئة PeerJS: ${e.message}. تأكد من تضمين مكتبة PeerJS بشكل صحيح.`, 'error');
                console.error("PeerJS initialization failed:", e);
            }
        }

        // 3. الحصول على البث المحلي (الكاميرا والميكروفون)
        async function getLocalStreamHandler() {
            // التحقق من السياق الآمن (HTTPS/localhost) قبل getUserMedia
            if (window.location.protocol!== 'https:' && window.location.hostname!== 'localhost' && window.location.hostname!== '127.0.0.1') {
                addStatusMessage("يتطلب getUserMedia سياقًا آمنًا (HTTPS أو localhost). يرجى نشر تطبيقك على HTTPS.", 'error');
                alert("يتطلب getUserMedia سياقًا آمنًا (HTTPS أو localhost). يرجى نشر تطبيقك على HTTPS.");
                return;
            }

            try {
                if (!navigator.mediaDevices ||!navigator.mediaDevices.getUserMedia) {
                    throw new Error("WebRTC غير مدعوم بواسطة متصفحك أو بيئتك.");
                }
                addStatusMessage("طلب الوصول إلى الكاميرا والميكروفون...");
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = stream;
                localStream = stream;
                startStreamBtn.disabled = true;
                addStatusMessage("تم الحصول على البث المحلي بنجاح.", 'success');
            } catch (err) {
                addStatusMessage(`فشل الحصول على البث المحلي: ${err.name} - ${err.message}. يرجى منح الأذونات.`, 'error');
                console.error("فشل الحصول على البث المحلي:", err);
                alert(`خطأ في الحصول على البث المحلي: ${err.message}. يرجى التأكد من منح أذونات الكاميرا والميكروفون.`);
            }
        }

        // 4. بدء مكالمة فيديو
        async function startCall() {
            const remotePeerId = peerIdInput.value;
            if (!peer |
| peer.destroyed) {
                addStatusMessage("PeerJS غير مهيأ أو تم تدميره. يرجى تحديث الصفحة.", 'error');
                return;
            }
            if (!localStream) {
                addStatusMessage("يرجى بدء البث المحلي أولاً.", 'error');
                await getLocalStreamHandler(); // محاولة الحصول على البث إذا لم يكن موجودًا
                if (!localStream) return;
            }
            if (!remotePeerId) {
                addStatusMessage("الرجاء إدخال معرف النظير للاتصال به.", 'error');
                return;
            }

            addStatusMessage(`الاتصال بـ: ${remotePeerId}...`, 'info');
            try {
                // التأكد من أن كائن النظير معرف قبل استدعاء.call()
                const call = peer.call(remotePeerId, localStream);
                if (!call) { // فحص إضافي إذا فشل peer.call() في إرجاع كائن
                    addStatusMessage("فشل إنشاء كائن المكالمة. قد يكون النظير غير متاح.", 'error');
                    return;
                }
                currentCall = call;
                hangupBtn.disabled = false;
                callBtn.disabled = true; // تعطيل زر الاتصال أثناء المكالمة

                // معالجة أحداث المكالمة
                call.on('stream', function(remoteStream) {
                    addStatusMessage(`تلقي بث الفيديو من ${call.peer}.`, 'success');
                    remoteVideo.srcObject = remoteStream;
                });

                call.on('close', function() {
                    addStatusMessage(`تم إنهاء المكالمة مع ${call.peer}.`, 'info');
                    remoteVideo.srcObject = null;
                    hangupBtn.disabled = true;
                    callBtn.disabled = false;
                    currentCall = null;
                });

                call.on('error', function(err) {
                    addStatusMessage(`خطأ في المكالمة مع ${call.peer}: ${err.type} - ${err.message}`, 'error');
                    console.error("Call error:", err);
                    remoteVideo.srcObject = null;
                    hangupBtn.disabled = true;
                    callBtn.disabled = false;
                    currentCall = null;
                });

            } catch (e) {
                addStatusMessage(`فشل بدء المكالمة: ${e.message}.`, 'error');
                console.error("Failed to start call:", e);
            }
        }

        // 5. الرد على مكالمة واردة
        async function answerCall() {
            if (!incomingCall) {
                addStatusMessage("لا توجد مكالمة واردة للرد عليها.", 'error');
                return;
            }
            if (!localStream) {
                addStatusMessage("يرجى بدء البث المحلي أولاً قبل الرد.", 'error');
                await getLocalStreamHandler();
                if (!localStream) return;
            }

            addStatusMessage(`الرد على المكالمة من: ${incomingCall.peer}...`, 'info');
            try {
                incomingCall.answer(localStream);
                currentCall = incomingCall;
                answerBtn.disabled = true;
                hangupBtn.disabled = false;
                callBtn.disabled = true; // تعطيل زر الاتصال أثناء المكالمة

                // معالجة أحداث المكالمة
                currentCall.on('stream', function(remoteStream) {
                    addStatusMessage(`تلقي بث الفيديو من ${currentCall.peer}.`, 'success');
                    remoteVideo.srcObject = remoteStream;
                });

                currentCall.on('close', function() {
                    addStatusMessage(`تم إنهاء المكالمة مع ${currentCall.peer}.`, 'info');
                    remoteVideo.srcObject = null;
                    hangupBtn.disabled = true;
                    callBtn.disabled = false;
                    incomingCall = null;
                    currentCall = null;
                });

                currentCall.on('error', function(err) {
                    addStatusMessage(`خطأ في المكالمة مع ${currentCall.peer}: ${err.type} - ${err.message}`, 'error');
                    console.error("Call error:", err);
                    remoteVideo.srcObject = null;
                    hangupBtn.disabled = true;
                    callBtn.disabled = false;
                    incomingCall = null;
                    currentCall = null;
                });

            } catch (e) {
                addStatusMessage(`فشل الرد على المكالمة: ${e.message}.`, 'error');
                console.error("Failed to answer call:", e);
            }
        }

        // 6. إنهاء المكالمة
        function hangUpCall() {
            if (currentCall) {
                addStatusMessage("إنهاء المكالمة...", 'info');
                currentCall.close(); // سيؤدي هذا إلى تشغيل حدث 'close'
            } else {
                addStatusMessage("لا توجد مكالمة نشطة لإنهاءها.", 'info');
            }
        }

        // ربط الأحداث بالأزرار
        startStreamBtn.addEventListener('click', getLocalStreamHandler);
        callBtn.addEventListener('click', startCall);
        answerBtn.addEventListener('click', answerCall);
        hangupBtn.addEventListener('click', hangUpCall);

        // بدء تهيئة PeerJS عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', initializePeer);
    </script>
</body>
</html>
