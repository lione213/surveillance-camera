<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>كاميرا المراقبة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        /* إصلاحات أساسية للفيديو */
        .video-container {
            position: relative;
            background-color: #000;
            overflow: hidden;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background-color: #000;
        }
        
        /* إصلاحات خاصة لمتصفحات iOS */
        @supports (-webkit-touch-callout: none) {
            video {
                position: absolute;
                top: 0;
                left: 0;
                width: 100% !important;
                height: 100% !important;
            }
        }
        
        /* إصلاح تشغيل الفيديو التلقائي على iOS */
        .ios-video-fix {
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen p-4">
    <div class="max-w-3xl mx-auto">
        <!-- واجهة المشاهدة -->
        <div id="viewer-mode" class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 shadow-lg mb-6">
            <h2 class="text-xl font-bold mb-3 text-center">مشاهدة البث</h2>
            
            <!-- إدخال رمز البث -->
            <div class="mb-4">
                <label for="connect-id" class="block mb-2 font-medium">رمز البث:</label>
                <div class="flex items-center">
                    <input id="connect-id" type="text" class="flex-grow p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-base" placeholder="أدخل رمز البث هنا" />
                    <button id="connect-btn" class="mr-2 px-6 py-3 bg-primary hover:bg-primary/80 text-white rounded-lg flex items-center justify-center transition-colors text-base">
                        اتصال
                    </button>
                </div>
            </div>
            
            <!-- عرض الفيديو المستقبل -->
            <div class="relative mb-4 overflow-hidden rounded-lg bg-black aspect-video video-container ios-video-fix">
                <video id="remote-video" autoplay playsinline muted class="w-full h-full"></video>
                
                <div id="no-stream-overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-900 bg-opacity-80 text-white p-4 text-center">
                    <p class="text-xl font-bold mb-2">لا يوجد بث متصل</p>
                    <p class="text-sm opacity-80">أدخل رمز البث واضغط على زر الاتصال</p>
                </div>
                <div id="connecting-overlay" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-gray-900 bg-opacity-80 text-white p-4 text-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-primary mb-4"></div>
                    <p class="text-xl font-bold mb-2">جاري الاتصال...</p>
                </div>
            </div>
            
            <!-- التحكم بالمشاهدة -->
            <div class="flex justify-center">
                <button id="disconnect-btn" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg flex items-center justify-center transition-colors text-base" disabled>
                    قطع الاتصال
                </button>
            </div>
            
            <!-- معلومات التصحيح -->
            <div class="mt-4 p-3 bg-gray-200 dark:bg-gray-700 rounded-lg text-sm">
                <div id="connection-status" class="mb-2">الحالة: غير متصل</div>
                <div id="ice-status" class="mb-2">حالة ICE: -</div>
                <button id="retry-btn" class="hidden mt-2 px-4 py-2 bg-yellow-500 text-white rounded">إعادة المحاولة</button>
            </div>
        </div>
    </div>

    <script>
        // العناصر الرئيسية
        const remoteVideoElement = document.getElementById('remote-video');
        const connectButton = document.getElementById('connect-btn');
        const disconnectButton = document.getElementById('disconnect-btn');
        const connectIdInput = document.getElementById('connect-id');
        const noStreamOverlay = document.getElementById('no-stream-overlay');
        const connectingOverlay = document.getElementById('connecting-overlay');
        const connectionStatus = document.getElementById('connection-status');
        const iceStatus = document.getElementById('ice-status');
        const retryButton = document.getElementById('retry-btn');
        
        // متغيرات الاتصال
        let peer = null;
        let activeCall = null;
        let retryCount = 0;
        const MAX_RETRIES = 3;
        
        // تكوين خادم PeerJS مع خوادم ICE محسنة
        const PEER_CONFIG = {
            config: {
                iceServers: [
                    // خوادم STUN
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:global.stun.twilio.com:3478?transport=udp' },
                    
                    // خوادم TURN (مهمة للاتصال عبر NAT)
                    {
                        urls: 'turn:global.turn.twilio.com:3478?transport=udp',
                        username: 'YOUR_TWILIO_USERNAME',
                        credential: 'YOUR_TWILIO_CREDENTIAL'
                    },
                    {
                        urls: 'turn:global.turn.twilio.com:3478?transport=tcp',
                        username: 'YOUR_TWILIO_USERNAME',
                        credential: 'YOUR_TWILIO_CREDENTIAL'
                    }
                ]
            },
            iceTransportPolicy: 'relay' // استخدام TURN فقط إذا فشل الاتصال المباشر
        };
        
        // تحديث حالة الاتصال
        function updateConnectionStatus(status, isError = false) {
            connectionStatus.textContent = `الحالة: ${status}`;
            if (isError) {
                connectionStatus.style.color = '#ef4444';
            } else {
                connectionStatus.style.color = '';
            }
        }
        
        // تحديث حالة ICE
        function updateIceStatus(status) {
            iceStatus.textContent = `حالة ICE: ${status}`;
        }
        
        // إعادة تعيين حالة المشاهد
        function resetViewer() {
            if (activeCall) {
                activeCall.close();
                activeCall = null;
            }
            
            if (peer) {
                peer.destroy();
                peer = null;
            }
            
            if (remoteVideoElement.srcObject) {
                remoteVideoElement.srcObject.getTracks().forEach(track => track.stop());
                remoteVideoElement.srcObject = null;
            }
            
            noStreamOverlay.classList.remove('hidden');
            connectingOverlay.classList.add('hidden');
            disconnectButton.disabled = true;
            connectButton.disabled = false;
            updateConnectionStatus("غير متصل");
            updateIceStatus("-");
            retryButton.classList.add('hidden');
        }
        
        // تشغيل الفيديو مع معالجة الأخطاء
        function playVideoWithRetry(videoElement, retries = 3) {
            return new Promise((resolve, reject) => {
                const playAttempt = (attempt) => {
                    videoElement.play()
                        .then(() => resolve())
                        .catch(err => {
                            if (attempt < retries) {
                                console.log(`محاولة تشغيل الفيديو (${attempt + 1}/${retries})`);
                                setTimeout(() => playAttempt(attempt + 1), 1000 * attempt);
                            } else {
                                reject(err);
                            }
                        });
                };
                playAttempt(0);
            });
        }
        
        // الاتصال بالبث
        async function connectToBroadcast() {
            const broadcastId = connectIdInput.value.trim().toUpperCase();
            
            if (!broadcastId) {
                alert("يرجى إدخال رمز البث");
                return;
            }
            
            resetViewer();
            retryCount = 0;
            
            noStreamOverlay.classList.add('hidden');
            connectingOverlay.classList.remove('hidden');
            connectButton.disabled = true;
            updateConnectionStatus("جاري الاتصال...");
            
            try {
                // إنشاء اتصال Peer جديد
                peer = new Peer(null, PEER_CONFIG);
                
                peer.on('error', err => {
                    console.error('خطأ في Peer:', err);
                    updateConnectionStatus(`خطأ: ${err.type}`, true);
                    
                    if (retryCount < MAX_RETRIES) {
                        retryCount++;
                        setTimeout(connectToBroadcast, 2000);
                    } else {
                        resetViewer();
                        alert("فشل الاتصال بعد عدة محاولات. يرجى المحاولة لاحقًا.");
                    }
                });
                
                peer.on('disconnected', () => {
                    console.log('تم قطع الاتصال');
                    updateConnectionStatus("تم قطع الاتصال", true);
                    retryButton.classList.remove('hidden');
                });
                
                peer.on('close', () => {
                    console.log('تم إغلاق الاتصال');
                    resetViewer();
                });
                
                peer.on('open', () => {
                    updateConnectionStatus("جاري الاتصال بالبث...");
                    
                    // إنشاء اتصال الفيديو
                    activeCall = peer.call(broadcastId, new MediaStream());
                    
                    activeCall.on('stream', async remoteStream => {
                        console.log('تم استقبال البث!');
                        updateConnectionStatus("متصل بالبث");
                        
                        // إيقاف أي تدفق سابق
                        if (remoteVideoElement.srcObject) {
                            remoteVideoElement.srcObject.getTracks().forEach(track => track.stop());
                        }
                        
                        // تعيين التدفق الجديد
                        remoteVideoElement.srcObject = remoteStream;
                        
                        // محاولة تشغيل الفيديو
                        try {
                            await playVideoWithRetry(remoteVideoElement);
                            console.log('تم تشغيل الفيديو بنجاح');
                            connectingOverlay.classList.add('hidden');
                            disconnectButton.disabled = false;
                            
                            // إضافة مستمع للأخطاء
                            remoteVideoElement.onerror = () => {
                                console.error('حدث خطأ في الفيديو');
                                updateConnectionStatus("خطأ في تشغيل الفيديو", true);
                            };
                            
                            // تتبع حالة ICE
                            activeCall.peerConnection.oniceconnectionstatechange = () => {
                                const state = activeCall.peerConnection.iceConnectionState;
                                updateIceStatus(state);
                                
                                if (state === 'disconnected' || state === 'failed') {
                                    updateConnectionStatus("انقطع الاتصال", true);
                                    retryButton.classList.remove('hidden');
                                }
                            };
                            
                        } catch (err) {
                            console.error('فشل تشغيل الفيديو:', err);
                            updateConnectionStatus("فشل تشغيل الفيديو", true);
                            retryButton.classList.remove('hidden');
                        }
                    });
                    
                    activeCall.on('close', () => {
                        console.log('تم إغلاق المكالمة');
                        resetViewer();
                    });
                    
                    activeCall.on('error', err => {
                        console.error('خطأ في المكالمة:', err);
                        updateConnectionStatus(`خطأ: ${err.message}`, true);
                        retryButton.classList.remove('hidden');
                    });
                });
                
            } catch (error) {
                console.error('خطأ في الاتصال:', error);
                updateConnectionStatus(`خطأ: ${error.message}`, true);
                resetViewer();
            }
        }
        
        // إعداد مستمعي الأحداث
        connectButton.addEventListener('click', connectToBroadcast);
        disconnectButton.addEventListener('click', resetViewer);
        retryButton.addEventListener('click', connectToBroadcast);
        
        // تمكين الاتصال عند الضغط على Enter
        connectIdInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                connectToBroadcast();
            }
        });
        
        // إصلاح خاص لأجهزة iOS
        document.addEventListener('click', () => {
            // على iOS، قد يتطلب تشغيل الفيديو تفاعل المستخدم
            if (remoteVideoElement.paused && remoteVideoElement.srcObject) {
                remoteVideoElement.play().catch(e => console.log('فشل التشغيل التلقائي:', e));
            }
        }, false);
    </script>
</body>
</html>
