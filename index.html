
<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>بث مباشر</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    video { width: 90%; max-width: 600px; margin: 15px 0; border: 1px solid #ccc; border-radius: 8px; }
    #roleSelector { margin-bottom: 20px; }
  </style>
</head>
<body>
  <h2>📡 نظام البث المباشر</h2>

  <div id="roleSelector">
    <label><input type="radio" name="role" value="broadcaster" checked /> مشغل بث</label>
    <label><input type="radio" name="role" value="viewer" /> مشاهد</label>
  </div>

  <input type="text" id="roomInput" placeholder="رمز الغرفة" />
  <button id="startBtn">ابدأ</button>

  <div id="videoContainer">
    <video id="localVideo" autoplay muted playsinline style="display: none;"></video>
    <video id="remoteVideo" autoplay playsinline controls style="display: none;"></video>
  </div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    const socket = io("https://webrtc-server-gbuq.onrender.com");
    const roomInput = document.getElementById("roomInput");
    const startBtn = document.getElementById("startBtn");
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const roleSelector = document.getElementsByName("role");

    let pc;
    let localStream;
    let role = "broadcaster";
    let room = "";

    const config = {
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    };

    startBtn.onclick = async () => {
      room = roomInput.value.trim();
      if (!room) return alert("يرجى إدخال رمز الغرفة");

      for (const r of roleSelector) {
        if (r.checked) role = r.value;
      }

      pc = new RTCPeerConnection(config);

      pc.onicecandidate = event => {
        if (event.candidate) {
          socket.emit("candidate", { room, candidate: event.candidate });
        }
      };

      if (role === "broadcaster") {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
        localVideo.style.display = "block";

        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        socket.emit("join", room);

        socket.on("viewer-joined", async () => {
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          socket.emit("offer", { room, offer });
        });
      } else if (role === "viewer") {
        remoteVideo.style.display = "block";
        socket.emit("join", room);

        socket.on("offer", async (offer) => {
          await pc.setRemoteDescription(new RTCSessionDescription(offer));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          socket.emit("answer", { room, answer });
        });

        pc.ontrack = event => {
          remoteVideo.srcObject = event.streams[0];
        };
      }

      socket.on("answer", async (answer) => {
        await pc.setRemoteDescription(new RTCSessionDescription(answer));
      });

      socket.on("candidate", async ({ candidate }) => {
        try {
          await pc.addIceCandidate(new RTCIceCandidate(candidate));
        } catch (e) {
          console.error("خطأ في ICE:", e);
        }
      });
    };
  </script>
</body>
</html>
